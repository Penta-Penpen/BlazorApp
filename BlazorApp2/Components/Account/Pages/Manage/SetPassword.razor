@page "/Account/Manage/SetPassword"
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using BlazorApp2.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Set password</PageTitle>

<h3>Set your password</h3>
<StatusMessage Message="@_message" />
<p class="text-info">
    You do not have a local username/password for this site. Add a local
    account so you can log in without an external login.
</p>
@if (_isLoaded)
{
    <div class="row">
        <div class="col-md-6">
            <form action="/Account/Manage/PerformSetPassword" method="post">
                <AntiforgeryToken />
                @if (!string.IsNullOrEmpty(_message))
                {
                    <div class="text-danger" role="alert">@_message</div>
                }
                <div class="form-floating mb-3">
                    <input type="password" name="NewPassword" class="form-control" autocomplete="new-password" placeholder="Please enter your new password." required minlength="6" />
                    <label for="new-password" class="form-label">New password</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" name="ConfirmPassword" class="form-control" autocomplete="new-password" placeholder="Please confirm your new password." required minlength="6" />
                    <label for="confirm-password" class="form-label">Confirm password</label>
                </div>
                <button type="submit" class="w-100 btn btn-lg btn-primary">Set password</button>
            </form>
        </div>
    </div>
}

@code {
    private string? _message;
    private ApplicationUser _user = default!;
    private bool _isLoaded;

    [SupplyParameterFromQuery(Name = "error")]
    private string? Error { get; set; }

    [SupplyParameterFromQuery(Name = "status")]
    private string? Status { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Error))
        {
            _message = $"Error: {Error}";
        }
        else if (!string.IsNullOrEmpty(Status))
        {
            _message = Status;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = UserManager.GetUserId(authState.User);

        if (userId == null)
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        var user = await UserManager.FindByIdAsync(userId);
        if (user == null)
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        _user = user;

        var hasPassword = await UserManager.HasPasswordAsync(_user);
        if (hasPassword)
        {
            NavigationManager.NavigateTo("Account/Manage/ChangePassword");
            return;
        }

        _isLoaded = true;
    }
}
